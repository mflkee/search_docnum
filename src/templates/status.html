{% extends "base.html" %}

{% block title %}Status - Arshin Registry Synchronization System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>Processing Status</h3>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger">
                    <h5>Error</h5>
                    <p>{{ error }}</p>
                    <a href="/" class="btn btn-primary">Go to Upload</a>
                </div>
                {% else %}
                <div class="mb-3">
                    <label for="taskInput" class="form-label">Task ID</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="taskInput" value="{{ task.task_id }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="loadTaskStatus()">Refresh</button>
                    </div>
                </div>
                
                <div id="statusInfo">
                    <p><strong>Task ID:</strong> <span id="taskId">{{ task.task_id }}</span></p>
                    <p><strong>Status:</strong> <span id="statusText">{{ task.status.value }}</span></p>
                    <p><strong>Progress:</strong> <span id="progressValue">{{ task.progress }}%</span></p>
                    
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: {{ task.progress }}%"></div>
                    </div>
                    
                    <div id="details">
                        <p><strong>Created:</strong> {{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else 'N/A' }}</p>
                        {% if task.completed_at %}
                        <p><strong>Completed:</strong> {{ task.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% endif %}
                        {% if task.error_message %}
                        <p class="text-danger"><strong>Error:</strong> {{ task.error_message }}</strong></p>
                        {% endif %}
                    </div>
                    
                    <div id="actions" class="mt-3">
                        {% if task.status.value == 'COMPLETED' %}
                        <a href="/results/{{ task.task_id }}" class="btn btn-success">Download Results</a>
                        {% elif task.status.value == 'FAILED' %}
                        <a href="/" class="btn btn-primary">Upload New File</a>
                        {% endif %}
                        <a href="/" class="btn btn-secondary">New Upload</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 justify-content-center" id="recentTasks" style="display: none;">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Recent Tasks</h4>
            </div>
            <div class="card-body">
                <ul class="list-group" id="recentTasksList">
                    <!-- Recent tasks will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh status every 5 seconds if processing
    let refreshInterval;
    
    function loadTaskStatus() {
        const taskId = document.getElementById('taskInput').value || document.getElementById('taskId').textContent;
        if (!taskId) return;
        
        fetch(`/api/task-status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('statusText').textContent = 'Not found';
                    document.getElementById('progressValue').textContent = '0%';
                    document.getElementById('progressBar').style.width = '0%';
                    return;
                }
                
                document.getElementById('statusText').textContent = data.status;
                document.getElementById('progressValue').textContent = data.progress + '%';
                document.getElementById('progressBar').style.width = data.progress + '%';
                
                // If status is completed or failed, stop the refresh
                if (data.status === 'COMPLETED' || data.status === 'FAILED') {
                    clearInterval(refreshInterval);
                }
                
                // Update error message if present
                if (data.error_message) {
                    document.querySelector('#details').innerHTML += `<p class="text-danger"><strong>Error:</strong> ${data.error_message}</p>`;
                }
                
                // Update actions based on status
                const actionsDiv = document.getElementById('actions');
                let actionButtons = '<a href="/" class="btn btn-secondary">New Upload</a>';
                
                if (data.status === 'COMPLETED') {
                    actionButtons = `<a href="/results/${taskId}" class="btn btn-success">Download Results</a> ${actionButtons}`;
                } else if (data.status === 'FAILED') {
                    actionButtons = `<a href="/" class="btn btn-primary">Upload New File</a> ${actionButtons}`;
                }
                
                actionsDiv.innerHTML = actionButtons;
            })
            .catch(error => {
                console.error('Error fetching status:', error);
            });
    }
    
    // Check if page has loaded with a valid task and start auto-refresh if processing
    document.addEventListener('DOMContentLoaded', function() {
        const statusText = "{{ task.status.value if task else 'N/A' }}";
        if (statusText === "PROCESSING") {
            refreshInterval = setInterval(loadTaskStatus, 5000); // Refresh every 5 seconds
        }
    });
</script>
{% endblock %}